@page "/kişi/{bakılan_kişi}"
@layout AnaTaslak
@using System.Threading.Tasks
@using Esas
@using Kilnevüg
@using Bileşenler
@inject IJSRuntime JSruntime
@inject NavigationManager NavigationManager
@namespace sayfa

@if (oturum_açık)
{
    <div style="text-align:center; margin-top:1%;">
        <YönlendirenBaşlık şuraya_yönlendir="/ana" ilk_başlık=@bakılan_kullanıcı.KULLANICI_ADI
            ikinci_başlık="Ana Sayfaya Git" ilk_renk="#098bdc" ikinci_renk="#ff6600"/>
        <div style="margin-top: 2%;">
            <div class="kutu_0_120_0" style="width:25%; margin: 3% 0% 3% 8%; float:left;
            display:inline-block;">
                Beğeni: @ortalama_beğeni
            </div>
                <img src="@bakılan_kullanıcı.RESİM" width="10%" height="auto" style="text-align: center;"/>
            <div class="kutu_0_120_0" style="width:25%; margin: 3% 8% 3% 0%; float:right;
            display:inline-block;">
                Takipçi: @takipçi_niceliği
            </div>
        </div>
        <div style="margin-top:1%; text-align:center;">
            <button class="düğme_0_120_0" style="font-size:large; font-weight:normal;"
            @onclick="TakipDüğmesi">@TakipDüğmesininYazısı</button>
        </div>
    </div>
    <div style="margin-top: 3%;">
        <BelirliKişininPaylaşımları paylaşan="@bakılan_kullanıcı.KİMLİK"
            bakan=@bakan_kullanıcı.KİMLİK oturum=@oturum />
    </div>
}
else
{
    <h1 class="Yükleniyor">Yükleniyor</h1>
}

@code {
    [Parameter]
    public string bakılan_kişi {get; set;}
    private ÜyeBil bakılan_kullanıcı;
    private double ortalama_beğeni;
    private long takipçi_niceliği;
    private bool BakanTakipEdiyor;

    protected override void OnParametersSet()
    {
        string bakılanın_kimliği = Esas.VeriTabanı.Üyelik.KullanıcınınKimliği(bakılan_kişi);
        bakılan_kullanıcı = Esas.VeriTabanı.Üyelik.ÜyeBilgileri(bakılanın_kimliği);
        ortalama_beğeni = Esas.VeriTabanı.Beğeni.KişininBeğeniOrtalaması(bakılanın_kimliği);
        takipçi_niceliği = Esas.VeriTabanı.Takip.TakipçiNiceliği(bakılanın_kimliği);
    }

    private string TakipDüğmesininYazısı {get; set;}
    private void TakipDüğmesi()
    {
        if (!BakanTakipEdiyor)
        {
            İşlemler.Takipİşlemleri.TakipEt(bakan_kullanıcı.KİMLİK, bakılan_kullanıcı.KİMLİK,
                                            1, DateTime.Now);
        }
        else
        {
            Esas.VeriTabanı.Takip.TakibiBırak(bakan_kullanıcı.KİMLİK, bakılan_kullanıcı.KİMLİK);
        }
        OnParametersSet();
    }


    private string kullanıcı, oturum;
    private bool oturum_açık;
    public static ÜyeBil bakan_kullanıcı;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            var a = await JSruntime.InvokeAsync<string>("Çerezİşleri.ÇerezOku", "kullanıcı");
            kullanıcı = a.ToString(); a = null;
            var b = await JSruntime.InvokeAsync<string>("Çerezİşleri.ÇerezOku", "oturum");
            oturum = b.ToString(); b = null;
            devam(kullanıcı, oturum);
            StateHasChanged();
        }
        catch
        {
            NavigationManager.NavigateTo("/");
        }
    }
    private void devam(string kullanıcı_kimliği, string oturum_kimliği)
    {
        oturum_açık = Esas.VeriTabanı.Oturum.BuOturumAçık(oturum_kimliği, kullanıcı_kimliği);
        if (!oturum_açık)
        {
            NavigationManager.NavigateTo("/");
        }
        bakan_kullanıcı = Esas.VeriTabanı.Üyelik.ÜyeBilgileri(kullanıcı_kimliği);
        
        BakanTakipEdiyor = Esas.VeriTabanı.Takip.TakipEdiliyor(bakan_kullanıcı.KİMLİK,
                                                            bakılan_kullanıcı.KİMLİK);
        if (BakanTakipEdiyor)
        {
            TakipDüğmesininYazısı = "Takibi Bırak";
        }
        else 
        {
            TakipDüğmesininYazısı = "Takip Et";
        }
    }
}